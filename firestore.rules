rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - users can read and write their own profile
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for displaying names, avatars, etc.)
      allow read: if request.auth != null;
      
      // Users can only write to their own profile
      allow create, update: if request.auth != null && request.auth.uid == userId;
      
      // Prevent deletion of user profiles
      allow delete: if false;
    }
    
    // Channels collection
    match /channels/{channelId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && request.auth.uid == resource.data.ownerId;
      }

      function isOwnerOnCreate() {
        return isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      }

      function isSubscriber() {
        return isSignedIn()
          && (resource.data.subscribers is list)
          && (request.auth.uid in resource.data.subscribers);
      }

      // Reading: owners and subscribers can read a channel
      allow read: if isOwner() || isSubscriber();

      // Create: only authenticated users can create a channel for themselves.
      // Additionally enforce a limit on custom (non-daily) channels. Clients
      // must maintain a `customChannelCount` integer on the user's
      // document (`users/{uid}.customChannelCount`). Creation of a non-daily
      // channel is allowed only when that count is < 3. Daily channels are
      // exempt from this limit.
      allow create: if isOwnerOnCreate()
        && (
          // Allow creating daily channels regardless of the count
          request.resource.data.isDaily == true
          // Or allow creating non-daily channels only when the user's
          // `customChannelCount` exists and is less than 3
          || (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.customChannelCount is int
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.customChannelCount < 3
          )
        )

      // Update: only owner may modify; ownerId and id cannot be changed
      allow update: if isOwner()
        && request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.id == resource.data.id

      // Deletion of channels is disallowed from clients
      allow delete: if false;
    }

    // Default: authenticated users may read other collections, but writes are
    // prohibited unless explicitly allowed above. This prevents accidental
    // open-write rules in development.
    match /{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}
