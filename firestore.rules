rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }
    // Helper: verify a user profile document exists
    function userProfileExists(uid) {
      return exists(/databases/$(database)/documents/users/$(uid));
    }

    // Users collection - users can read and write their own profile
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for displaying names, avatars, etc.)
      allow read: if isSignedIn();
      
      // Users can only write to their own profile
      allow create, update: if isSignedIn() && request.auth.uid == userId;
      
      // Prevent deletion of user profiles
      allow delete: if false;
    }
    
    // Channels collection
    match /channels/{channelId} {
      function isOwner() {
        return isSignedIn() && request.auth.uid == resource.data.ownerId;
      }

      function isOwnerOnCreate() {
        return isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      }

      function isSubscriber() {
        return isSignedIn()
          && (resource.data.subscribers is list)
          && (request.auth.uid in resource.data.subscribers);
      }

      // Reading: owners and subscribers can read a channel
      allow read: if isOwner() || isSubscriber();

      // Create: only authenticated users can create a channel for themselves.
      // Require that the creating user has a profile document in `/users/{uid}`.
      // Additionally enforce a limit on custom (non-daily) channels. Clients
      // must maintain a `customChannelCount` integer on the user's
      // document (`users/{uid}.customChannelCount`). Creation of a non-daily
      // channel is allowed only when that count is < 3. Daily channels are
      // exempt from this limit, but the user profile must still exist.
      allow create: if isOwnerOnCreate()
        // Require the user's profile to exist in `/users/{uid}`
        && userProfileExists(request.auth.uid)
        && (
          // Allow creating daily channels when the user exists
          request.resource.data.isDaily == true
          // Or allow creating non-daily channels only when the user's
          // `customChannelCount` exists and is less than 3
          || (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.customChannelCount is int
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.customChannelCount < 3
          )
        )

      // Update: only owner may modify; ownerId and id cannot be changed
      allow update: if isOwner()
        && request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.id == resource.data.id

      // Deletion: owners may delete their custom (non-daily) channels.
      // Daily channels are system-managed and cannot be deleted by clients.
      allow delete: if isOwner() && resource.data.isDaily == false;
    }

    // Default: authenticated users may read other collections, but writes are
    // prohibited unless explicitly allowed above. This prevents accidental
    // open-write rules in development.
    match /{document=**} {
      allow read: if isSignedIn();
      allow write: if false;
    }
  }
}
